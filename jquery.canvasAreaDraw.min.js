!function(e){e.fn.canvasAreaDraw=function(n){var i=Array.prototype.slice.call(arguments,1),o=null;return this.each(function(r,a){instance=e(a).data("canvasAreaDraw"),instance?"string"==typeof n&&("undefined"==typeof instance[n]?console.log("Undefined function: "+n):o=instance[n].apply(instance,i)):e(a).data("canvasAreaDraw",t.apply(a,[r,a,n]))}),o};var t=function(t,r,a){var f,s,g,l,d,u,c,h,p,v,y,m,w,R,_,M,N=this,X=0;return l=e.extend({imageUrl:e(this).attr("data-image-url"),width:!1,height:!1,sensitivity:6,rectWidth:2,lineWidth:1,initialRegions:1,defaultColor:"#ff0000"},a),R=function(){l.height?c.attr("height",l.height):c.attr("height",p.height),l.width?c.attr("width",l.width):c.attr("width",p.width),v()},w=function(t){t.offsetX||(isNaN(t.pageX)||isNaN(t.pageY)?(t.offsetX=event.targetTouches[0].pageX-e(t.target).offset().left,t.offsetY=event.targetTouches[0].pageY-e(t.target).offset().top):(t.offsetX=t.pageX-e(t.target).offset().left,t.offsetY=t.pageY-e(t.target).offset().top)),f[d][g]=Math.round(t.offsetX),f[d][g+1]=Math.round(t.offsetY),v()},m=function(){e(this).off("mousemove"),M(),g=null},_=function(t){t.preventDefault(),"undefined"==typeof f[d]&&alert("No region is selected."),t.offsetX||(t.offsetX=t.pageX-e(t.target).offset().left,t.offsetY=t.pageY-e(t.target).offset().top);for(var n=t.offsetX,i=t.offsetY,o=0;o<f[d].length;o+=2)if(dis=Math.sqrt(Math.pow(n-f[d][o],2)+Math.pow(i-f[d][o+1],2)),dis<6)return f[d].splice(o,2),v(),M(),!1;return!1},y=function(t){t.preventDefault(),"undefined"==typeof f[d]&&alert("No region is selected.");var i,o,r,a,s=f[d].length;if(3===t.which)return!1;t.offsetX||(t.offsetX=t.pageX-e(t.target).offset().left,t.offsetY=t.pageY-e(t.target).offset().top),i=t.offsetX,o=t.offsetY,(isNaN(i)||isNaN(o))&&(i=event.targetTouches[0].pageX-e(t.target).offset().left,o=event.targetTouches[0].pageY-e(t.target).offset().top);for(var u=0;u<f[d].length;u+=2)if(r=Math.sqrt(Math.pow(i-f[d][u],2)+Math.pow(o-f[d][u+1],2)),r<l.sensitivity)return g=u,e(this).on("touchmove mousemove",w),!1;for(var u=0;u<f[d].length;u+=2)u>1&&(a=n(i,o,f[d][u],f[d][u+1],f[d][u-2],f[d][u-1],!0),6>a&&(s=u));return f[d].splice(s,0,Math.round(i),Math.round(o)),g=s,e(this).on("mousemove",w),v(),M(),!1},v=function(){M(),h.canvas.width=h.canvas.width,h.globalCompositeOperation="destination-over",h.lineWidth=l.lineWidth;var t=l.rectWidth;for(region_id in f){if(n=!1,"undefined"!=typeof s[region_id])var n=o(s[region_id].color);else var n=o(l.defaultColor);if(n?(h.fillStyle="rgba("+n.r+","+n.g+","+n.b+",0.3)",h.strokeStyle="rgba("+n.r+","+n.g+","+n.b+",1)"):(h.fillStyle="rgba(255,0,0,0.3)",h.strokeStyle="rgba(255,0,0,1)"),f[region_id].length>0){h.beginPath(),h.moveTo(f[region_id][0],f[region_id][1]);for(var i=0;i<f[region_id].length;i+=2)h.fillRect(f[region_id][i]-t,f[region_id][i+1]-t,2*t,2*t),h.strokeRect(f[region_id][i]-t,f[region_id][i+1]-t,2*t,2*t),f[region_id].length>2&&i>1&&h.lineTo(f[region_id][i],f[region_id][i+1]);h.closePath(),region_id==d&&h.fill(),h.stroke()}}e(r).trigger({type:"drawingFinished"})},M=function(){var t={points:f,metadata:s};console.log("record"),console.log(t),e(r).val(JSON.stringify(t)),e(r).trigger({type:"pointDataChange",points:f,metadata:s})},c=e("<canvas>"),h=c[0].getContext("2d"),f={},s={},e(this).val().length?(allData=JSON.parse(e(this).val()),f=allData.points,s=allData.metadata):l.points&&(allData=l.points,f=allData.points,s=allData.metadata,e(this).val(JSON.stringify(allData))),d=0,u=-1,p=new Image,e(p).load(R),p.src=l.imageUrl,p.loaded&&R(),c.css("background-image",'url("'+p.src+'")'),e(document).ready(function(){if(Object.keys(f).length>0)for(region in f)N.addRegion();else for(i=0;i<l.initialRegions;i++)N.addRegion();l.noRegionsSelector&&0==X&&e(l.noRegionsSelector).show(),e(r).after(c),c.on("mousedown touchstart",y),c.on("contextmenu",_),c.on("mouseup touchend",m)}),e(r).on("change",function(){f[d]=e(this).val().length?e(this).val().split(",").map(function(e){return parseInt(e,10)}):[],v()}),this.setRegionColor=function(t,n){s[t].color=n,e(r).trigger({type:"regionColorSet",region_id:t,color_code:n}),v()},this.getRegionColor=function(e){return"undefined"!=typeof s[e]&&"undefined"!=s[e].color?s[e].color:l.defaultColor},this.addRegion=function(){return X++,u++,"undefined"==typeof f[u]&&(f[u]=[],s[u]={}),e(r).trigger({type:"regionAdded",region_id:u}),N.selectRegion(u),v(),u},this.removeRegion=function(t){if("undefined"==typeof f[t])console.log("No region matching region_id: "+t);else{var n={};for(i in f)t!=i&&(n[i]=f[i]);t==d&&(d=null,g=null),f=n,e(r).trigger({type:"regionRemoved",region_id:t}),v()}},this.selectRegion=function(t){"undefined"==typeof f[t]?console.log("No region matching region_id: "+t):(d=t,g=null,e(r).trigger({type:"regionSelected",region_id:t}),v())},this.getRegionIds=function(){var e=[];for(i in f)e.push(i);return e},this.getNumberOfRegions=function(){return X},this.getActiveRegion=function(){return d},this.reset=function(){for(f={},s={},d=0,u=-1,X=0,i=0;i<l.initialRegions;i++)N.addRegion();l.noRegionsSelector&&0==X&&e(l.noRegionsSelector).show(),v()},this};e(document).ready(function(){e(".canvas-area[data-image-url]").canvasAreaDraw()});var n=function(e,t,n,i,o,r,a){function f(e,t,n,i){return Math.sqrt((e-=n)*e+(t-=i)*t)}if(!a||(a=function(e,t,n,i,o,r){if(!(o-n))return{x:n,y:t};if(!(r-i))return{x:e,y:i};var a,f=-1/((r-i)/(o-n));return{x:a=(o*(e*f-t+i)+n*(e*-f+t-r))/(f*(o-n)+i-r),y:f*a-f*e+t}}(e,t,n,i,o,r),a.x>=Math.min(n,o)&&a.x<=Math.max(n,o)&&a.y>=Math.min(i,r)&&a.y<=Math.max(i,r))){var s=i-r,g=o-n,l=n*r-i*o;return Math.abs(s*e+g*t+l)/Math.sqrt(s*s+g*g)}var d=f(e,t,n,i),u=f(e,t,o,r);return d>u?u:d},o=function(e){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}}(jQuery);